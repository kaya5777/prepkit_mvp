<div class="max-w-4xl">
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">履歴編集</h1>
    <p class="text-gray-600">会社名とメモを編集できます</p>
  </div>

  <%= form_with(model: @history, local: true, class: "space-y-8") do |form| %>
    <!-- Company Name -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <%= form.label :company_name, '会社名', class: 'block text-sm font-medium text-gray-700 mb-2' %>
      <%= form.text_field :company_name,
        value: @history.company_name,
        required: false,
        placeholder: '例：株式会社サンプル',
        class: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-shadow' %>
    </div>

    <!-- AI Content Preview -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
      <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-bold text-gray-900">想定質問（AI出力）</h2>
        <p class="text-sm text-gray-500 mt-1">この内容は編集できません</p>
      </div>
      <div class="p-6 max-h-[500px] overflow-y-auto bg-gray-50">
        <% if @presenter.valid_json? %>
          <div class="space-y-6">
            <% if @presenter.has_questions? %>
              <div>
                <h3 class="font-bold text-gray-900 mb-2">質問リスト</h3>
                <ul class="space-y-2 text-sm text-gray-700">
                  <% @presenter.questions.each do |q| %>
                    <li class="flex gap-2">
                      <span class="text-indigo-600">•</span>
                      <span><%= q %></span>
                    </li>
                  <% end %>
                </ul>
              </div>
            <% end %>
            <% if @presenter.has_star_answers? %>
              <div>
                <h3 class="font-bold text-gray-900 mb-2">STAR回答</h3>
                <% @presenter.star_answers.each do |s| %>
                  <div class="mb-4 text-sm text-gray-700 space-y-1">
                    <p><strong>質問:</strong> <%= s['question'] || s[:question] %></p>
                    <p><strong class="text-blue-600">S:</strong> <%= s['situation'] || s[:situation] %></p>
                    <p><strong class="text-purple-600">T:</strong> <%= s['task'] || s[:task] %></p>
                    <p><strong class="text-orange-600">A:</strong> <%= s['action'] || s[:action] %></p>
                    <p><strong class="text-green-600">R:</strong> <%= s['result'] || s[:result] %></p>
                  </div>
                <% end %>
              </div>
            <% end %>
            <% if @presenter.has_reverse_questions? %>
              <div>
                <h3 class="font-bold text-gray-900 mb-2">逆質問</h3>
                <ul class="space-y-2 text-sm text-gray-700">
                  <% @presenter.reverse_questions.each do |q| %>
                    <li class="flex gap-2">
                      <span class="text-purple-600">•</span>
                      <span><%= q %></span>
                    </li>
                  <% end %>
                </ul>
              </div>
            <% end %>
            <% if @presenter.has_tech_checklist? %>
              <div>
                <h3 class="font-bold text-gray-900 mb-2">技術チェックリスト</h3>
                <ul class="space-y-2 text-sm text-gray-700">
                  <% @presenter.tech_checklist.each do |q| %>
                    <li class="flex gap-2">
                      <span class="text-orange-600">•</span>
                      <span><%= q %></span>
                    </li>
                  <% end %>
                </ul>
              </div>
            <% end %>
          </div>
        <% else %>
          <pre class="bg-white p-4 rounded-lg text-sm text-gray-700 whitespace-pre-wrap break-words"><%= @presenter.content %></pre>
        <% end %>
      </div>
    </div>

    <!-- Stage-specific Memos -->
    <% if @presenter.multi_stage? %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-bold text-gray-900">面接段階別メモ</h2>
        </div>
        <div class="p-6 space-y-6">
          <div>
            <%= form.label :stage_1_memo, '1次面接（現場クラス）メモ', class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= form.text_area :stage_1_memo,
              class: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-shadow resize-y min-h-[120px]',
              placeholder: '1次面接のメモを入力してください...' %>
          </div>

          <div>
            <%= form.label :stage_2_memo, '2次面接（マネージャークラス）メモ', class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= form.text_area :stage_2_memo,
              class: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-shadow resize-y min-h-[120px]',
              placeholder: '2次面接のメモを入力してください...' %>
          </div>

          <div>
            <%= form.label :stage_3_memo, '3次面接（社長・役員クラス）メモ', class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= form.text_area :stage_3_memo,
              class: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-shadow resize-y min-h-[120px]',
              placeholder: '3次面接のメモを入力してください...' %>
          </div>
        </div>
      </div>
    <% else %>
      <!-- Single Memo for legacy data -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <%= form.label :memo, 'メモ', class: 'block text-sm font-medium text-gray-700 mb-2' %>
        <%= form.text_area :memo,
          class: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-shadow resize-y min-h-[150px]',
          placeholder: 'メモを入力してください...' %>
      </div>
    <% end %>

    <!-- Actions -->
    <div class="flex gap-4 justify-end">
      <%= link_to history_path(@history), class: "inline-flex items-center px-6 py-3 bg-white border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition-colors" do %>
        キャンセル
      <% end %>
      <%= form.submit '更新',
        class: 'inline-flex items-center px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg shadow-sm transition-colors cursor-pointer' %>
    </div>
  <% end %>
</div>
