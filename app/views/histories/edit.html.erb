<h1>メモ編集</h1>
<%= form_with(model: @history, local: true) do |form| %>
  <div>
    <%= form.label :company_name, '会社名' %><br>
    <%= form.text_field :company_name, value: @history.company_name, required: false %>
  </div>
  <div style="max-width:900px;margin:0 auto;">
    <%= form.label :content, '想定質問（AI出力）' %><br>
    <div style="max-height:400px; overflow-y:auto; background:#f9f9f9; border:1px solid #ececec; border-radius:7px; padding:16px; margin-bottom:20px;">
      <% begin %>
        <%
          # マークダウンコードブロック記法を除去してからJSONをパース
          clean_content = @history.content.to_s.gsub(/```json\s*/, '').gsub(/```\s*$/, '').strip
          content_hash = JSON.parse(clean_content) rescue nil
        %>
        <% if content_hash.is_a?(Hash) %>
          <% if content_hash['questions'] || content_hash[:questions] %>
            <div style="margin-bottom:6px;font-weight:bold;font-size:0.98em;">質問リスト</div>
            <ul style="font-size:0.93em; margin:5px 0 14px 18px;">
              <% (content_hash['questions'] || content_hash[:questions]).each do |q| %>
                <li><%= q %></li>
              <% end %>
            </ul>
          <% end %>
          <% if content_hash['star_answers'] || content_hash[:star_answers] %>
            <div style="margin-bottom:6px;font-weight:bold;font-size:0.98em;">STAR回答</div>
            <% (content_hash['star_answers'] || content_hash[:star_answers]).each do |s| %>
              <div style="margin-bottom:7px; padding-left:10px; font-size:0.93em;">
                <b>質問:</b> <%= s['question'] || s[:question] %><br>
                <b>S:</b> <%= s['situation'] || s[:situation] %><br>
                <b>T:</b> <%= s['task'] || s[:task] %><br>
                <b>A:</b> <%= s['action'] || s[:action] %><br>
                <b>R:</b> <%= s['result'] || s[:result] %>
              </div>
            <% end %>
          <% end %>
          <% if content_hash['reverse_questions'] || content_hash[:reverse_questions] %>
            <div style="margin-bottom:6px;font-weight:bold;font-size:0.98em;">逆質問</div>
            <ul style="font-size:0.93em; margin:5px 0 14px 18px;">
              <% (content_hash['reverse_questions'] || content_hash[:reverse_questions]).each do |q| %>
                <li><%= q %></li>
              <% end %>
            </ul>
          <% end %>
          <% if content_hash['tech_checklist'] || content_hash[:tech_checklist] %>
            <div style="margin-bottom:6px;font-weight:bold;font-size:0.98em;">技術チェックリスト</div>
            <ul style="font-size:0.93em; margin:5px 0 14px 18px;">
              <% (content_hash['tech_checklist'] || content_hash[:tech_checklist]).each do |q| %>
                <li><%= q %></li>
              <% end %>
            </ul>
          <% end %>
        <% else %>
          <p style="background:#f7f7f8; padding:8px 10px; border-radius:6px; border:1px solid #ececec; font-size:0.98em;"> <%= @history.content %> </p>
        <% end %>
      <% rescue %>
        <p style="background:#f7f7f8; padding:8px 10px; border-radius:6px; border:1px solid #ececec; font-size:0.98em;"> <%= @history.content %> </p>
      <% end %>
    </div>
  </div>
  <div style="max-width:900px;margin:0 auto;">
    <%= form.label :memo, 'メモ' %><br>
    <%= form.text_area :memo, style: 'min-height:120px;width:100%;font-size:1.06em;padding:10px;margin-bottom:10px;' %>
    <div style="display:flex; gap:18px;">
      <%= form.submit '更新', style: 'font-size:1.09em;padding:8px 28px;' %>
      <%= link_to '戻る', root_path, style: 'font-size:1.02em;padding:8px 24px;background:#faf6f3;border-radius:6px;text-decoration:none;border:1px solid #eee;' %>
    </div>
  </div>
<% end %>
